{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Parameters": {
    "TablePrefix": {
      "Default": "console-private",
      "Description": "",
      "Type": "String"
    }
  },
  "Outputs": {
    "DynamoDBAccessKeyId": {
      "Value": {
        "Ref": "ConsolePrivateDynamoDBAccess"
      }
    },
    "DynamoDBSecretAccessKey": {
      "Value": { "Fn::GetAtt": [ "ConsolePrivateDynamoDBAccess", "SecretAccessKey" ] }
    }
  },
  "Resources": {
    "ConsolePrivateDynamoDBUser": {
      "Type": "AWS::IAM::User",
      "Properties": {
        "Policies": [
          {
            "PolicyName": "ConsolePrivateDynamoDBFullAccess",
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [{ 
                "Effect": "Allow", 
                "Action": [
                  "dynamodb:BatchGetItem",
                  "dynamodb:BatchWriteItem",
                  "dynamodb:DeleteItem",
                  "dynamodb:DescribeStream",
                  "dynamodb:DescribeTable",
                  "dynamodb:GetItem",
                  "dynamodb:GetRecords",
                  "dynamodb:ListStreams",
                  "dynamodb:ListTables",
                  "dynamodb:PutItem",
                  "dynamodb:Query",
                  "dynamodb:UpdateItem"
                ],
                "Resource": {
                  "Fn::Join": [
                    "", 
                    [
                      "arn:aws:dynamodb:*:*:table/",
                      {"Ref": "TablePrefix"},
                      "-*"
                    ]
                  ]
                }
              }]
            }
          }
        ]
      }
    },
    "ConsolePrivateDynamoDBAccess": {
      "Type": "AWS::IAM::AccessKey",
      "Properties": {
        "Serial": "1",
        "Status": "Active",
        "UserName": { "Ref": "ConsolePrivateDynamoDBUser" }
      }
    },
    "ConsolePrivateUsersDynamoDBTable" : {
      "Type" : "AWS::DynamoDB::Table",
      "DeletionPolicy" : "Retain",
      "Properties" : {
        "TableName" : {"Fn::Join" : ["", [{"Ref": "TablePrefix"}, "-users" ]]},
        "AttributeDefinitions" : [
          { "AttributeName" : "id", "AttributeType" : "S" },
          { "AttributeName" : "email", "AttributeType" : "S" },
          { "AttributeName" : "api-key-hash", "AttributeType" : "S" },
        ],
        "KeySchema" : [{ "AttributeName" : "id", "KeyType" : "HASH" }],
        "ProvisionedThroughput" : { "ReadCapacityUnits" : "1", "WriteCapacityUnits" : "1" },
        "GlobalSecondaryIndexes" : [{
          "IndexName" : "email-index",
          "Projection": { "ProjectionType": "ALL" },
          "KeySchema" : [{ "AttributeName" : "email", "KeyType" : "HASH"}],                         
          "ProvisionedThroughput" : { "ReadCapacityUnits" : "1", "WriteCapacityUnits" : "1" }
        },
        {
          "IndexName" : "api-key-hash-index",
          "Projection": { "ProjectionType": "ALL" },
          "KeySchema" : [{ "AttributeName" : "api-key-hash", "KeyType" : "HASH" }],                         
          "ProvisionedThroughput" : { "ReadCapacityUnits" : "1", "WriteCapacityUnits" : "1" }
        }]
      }
    },
    "ConsolePrivateOrganizationsDynamoDBTable" : {
      "Type" : "AWS::DynamoDB::Table",
      "DeletionPolicy" : "Retain",
      "Properties" : {
        "TableName" : {"Fn::Join" : ["", [{"Ref": "TablePrefix"}, "-organizations" ]]},
        "AttributeDefinitions" : [
          { "AttributeName" : "id", "AttributeType" : "S" },
          { "AttributeName" : "name", "AttributeType" : "S" }
        ],
        "KeySchema" : [{ "AttributeName" : "id", "KeyType" : "HASH" }],
        "ProvisionedThroughput" : { "ReadCapacityUnits" : "1", "WriteCapacityUnits" : "1" },
        "GlobalSecondaryIndexes" : [{
          "IndexName" : "name-index",
          "Projection": { "ProjectionType": "ALL" },
          "KeySchema" : [{ "AttributeName" : "name", "KeyType" : "HASH"}],                         
          "ProvisionedThroughput" : { "ReadCapacityUnits" : "1", "WriteCapacityUnits" : "1" }
        }]
      }
    },
    "ConsolePrivateOrganizationInvitesDynamoDBTable" : {
      "Type" : "AWS::DynamoDB::Table",
      "DeletionPolicy" : "Retain",
      "DependsOn" : "ConsolePrivateOrganizationsDynamoDBTable" ,
      "Properties" : {
        "TableName" : {"Fn::Join" : ["", [{"Ref": "TablePrefix"}, "-organization-invites" ]]},
        "AttributeDefinitions" : [
          { "AttributeName" : "id", "AttributeType" : "S" },
          { "AttributeName" : "email", "AttributeType" : "S" },
          { "AttributeName" : "organization-id", "AttributeType" : "S" },
          { "AttributeName" : "inviter-id", "AttributeType" : "S" },
          { "AttributeName" : "token", "AttributeType" : "S" }
        ],
        "KeySchema" : [{ "AttributeName" : "id", "KeyType" : "HASH" }],
        "ProvisionedThroughput" : { "ReadCapacityUnits" : "1", "WriteCapacityUnits" : "1" },
        "GlobalSecondaryIndexes" : [{
          "IndexName" : "email-index",
          "Projection": { "ProjectionType": "ALL" },
          "KeySchema" : [{ "AttributeName" : "email", "KeyType" : "HASH"}],                         
          "ProvisionedThroughput" : { "ReadCapacityUnits" : "1", "WriteCapacityUnits" : "1" }
        }, {
        "IndexName" : "organization-id-index",
        "Projection": { "ProjectionType": "ALL" },
        "KeySchema" : [{ "AttributeName" : "organization-id", "KeyType" : "HASH"}],                         
        "ProvisionedThroughput" : { "ReadCapacityUnits" : "1", "WriteCapacityUnits" : "1" }
        }, {
        "IndexName" : "inviter-id-index",
        "Projection": { "ProjectionType": "ALL" },
        "KeySchema" : [{ "AttributeName" : "inviter-id", "KeyType" : "HASH"}],                         
        "ProvisionedThroughput" : { "ReadCapacityUnits" : "1", "WriteCapacityUnits" : "1" }
        }, {
        "IndexName" : "token-index",
        "Projection": { "ProjectionType": "ALL" },
        "KeySchema" : [{ "AttributeName" : "token", "KeyType" : "HASH"}],                         
        "ProvisionedThroughput" : { "ReadCapacityUnits" : "1", "WriteCapacityUnits" : "1" }
        }]
      }
    },
    "ConsolePrivateRacksDynamoDBTable" : {
      "Type" : "AWS::DynamoDB::Table",
      "DeletionPolicy" : "Retain",
      "DependsOn" : "ConsolePrivateOrganizationInvitesDynamoDBTable" ,
      "Properties" : {
        "TableName" : {"Fn::Join" : ["", [{"Ref": "TablePrefix"}, "-racks" ]]},
        "AttributeDefinitions" : [
          { "AttributeName" : "id", "AttributeType" : "S" },
          { "AttributeName" : "organization-id", "AttributeType" : "S" },
          { "AttributeName" : "creator", "AttributeType" : "S" }
        ],
        "KeySchema" : [{ "AttributeName" : "id", "KeyType" : "HASH" }],
        "ProvisionedThroughput" : { "ReadCapacityUnits" : "1", "WriteCapacityUnits" : "1" },
        "GlobalSecondaryIndexes" : [{
          "IndexName" : "creator-index",
          "Projection": { "ProjectionType": "ALL" },
          "KeySchema" : [{ "AttributeName" : "creator", "KeyType" : "HASH"}],                         
          "ProvisionedThroughput" : { "ReadCapacityUnits" : "1", "WriteCapacityUnits" : "1" }
        }, {
        "IndexName" : "organization-id-index",
        "Projection": { "ProjectionType": "ALL" },
        "KeySchema" : [{ "AttributeName" : "organization-id", "KeyType" : "HASH"}],                         
        "ProvisionedThroughput" : { "ReadCapacityUnits" : "1", "WriteCapacityUnits" : "1" }
        }]
      }
    },
    "ConsolePrivateInstallsDynamoDBTable" : {
      "Type" : "AWS::DynamoDB::Table",
      "DeletionPolicy" : "Retain",
      "DependsOn" : "ConsolePrivateRacksDynamoDBTable" ,
      "Properties" : {
        "TableName" : {"Fn::Join" : ["", [{"Ref": "TablePrefix"}, "-installs" ]]},
        "AttributeDefinitions" : [
          { "AttributeName" : "id", "AttributeType" : "S" },
          { "AttributeName" : "user-id", "AttributeType" : "S" }
        ],
        "KeySchema" : [{ "AttributeName" : "id", "KeyType" : "HASH" }],
        "ProvisionedThroughput" : { "ReadCapacityUnits" : "1", "WriteCapacityUnits" : "1" },
        "GlobalSecondaryIndexes" : [{
          "IndexName" : "user-id-index",
          "Projection": { "ProjectionType": "ALL" },
          "KeySchema" : [{ "AttributeName" : "user-id", "KeyType" : "HASH"}],                         
          "ProvisionedThroughput" : { "ReadCapacityUnits" : "1", "WriteCapacityUnits" : "1" }
        }]
      }
    },
    "ConsolePrivateIntegrationsDynamoDBTable" : {
      "Type" : "AWS::DynamoDB::Table",
      "DeletionPolicy" : "Retain",
      "DependsOn" : "ConsolePrivateInstallsDynamoDBTable" ,
      "Properties" : {
        "TableName" : {"Fn::Join" : ["", [{"Ref": "TablePrefix"}, "-integrations" ]]},
        "AttributeDefinitions" : [
          { "AttributeName" : "id", "AttributeType" : "S" },
          { "AttributeName" : "provider", "AttributeType" : "S" },
          { "AttributeName" : "organization-id", "AttributeType" : "S" }
        ],
        "KeySchema" : [{ "AttributeName" : "id", "KeyType" : "HASH" }],
        "ProvisionedThroughput" : { "ReadCapacityUnits" : "1", "WriteCapacityUnits" : "1" },
        "GlobalSecondaryIndexes" : [{
          "IndexName" : "provider-index",
          "Projection": { "ProjectionType": "ALL" },
          "KeySchema" : [{ "AttributeName" : "provider", "KeyType" : "HASH"}],                         
          "ProvisionedThroughput" : { "ReadCapacityUnits" : "1", "WriteCapacityUnits" : "1" }
        }, {
        "IndexName" : "organization-id-index",
        "Projection": { "ProjectionType": "ALL" },
        "KeySchema" : [{ "AttributeName" : "organization-id", "KeyType" : "HASH"}],                         
        "ProvisionedThroughput" : { "ReadCapacityUnits" : "1", "WriteCapacityUnits" : "1" }
        }]
      }
    },
    "ConsolePrivateWebhooksDynamoDBTable" : {
      "Type" : "AWS::DynamoDB::Table",
      "DeletionPolicy" : "Retain",
      "DependsOn" : "ConsolePrivateIntegrationsDynamoDBTable" ,
      "Properties" : {
        "TableName" : {"Fn::Join" : ["", [{"Ref": "TablePrefix"}, "-webhooks" ]]},
        "AttributeDefinitions" : [
          { "AttributeName" : "id", "AttributeType" : "S" },
          { "AttributeName" : "integration-id", "AttributeType" : "S" },
          { "AttributeName" : "remote-id", "AttributeType" : "N" },
          { "AttributeName" : "rack-id", "AttributeType" : "S" },
          { "AttributeName" : "app-id", "AttributeType" : "S" }
        ],
        "KeySchema" : [{ "AttributeName" : "id", "KeyType" : "HASH" }],
        "ProvisionedThroughput" : { "ReadCapacityUnits" : "1", "WriteCapacityUnits" : "1" },
        "GlobalSecondaryIndexes" : [{
          "IndexName" : "integration-id-index",
          "Projection": { "ProjectionType": "ALL" },
          "KeySchema" : [{ "AttributeName" : "integration-id", "KeyType" : "HASH"}],                         
          "ProvisionedThroughput" : { "ReadCapacityUnits" : "1", "WriteCapacityUnits" : "1" }
        }, {
        "IndexName" : "remote-id-index",
        "Projection": { "ProjectionType": "ALL" },
        "KeySchema" : [{ "AttributeName" : "remote-id", "KeyType" : "HASH"}],                         
        "ProvisionedThroughput" : { "ReadCapacityUnits" : "1", "WriteCapacityUnits" : "1" }
        }, {
        "IndexName" : "app-id-index",
        "Projection": { "ProjectionType": "ALL" },
        "KeySchema" : [{ "AttributeName" : "app-id", "KeyType" : "HASH"}],                         
        "ProvisionedThroughput" : { "ReadCapacityUnits" : "1", "WriteCapacityUnits" : "1" }
        }, {
        "IndexName" : "rack-id-index",
        "Projection": { "ProjectionType": "ALL" },
        "KeySchema" : [{ "AttributeName" : "rack-id", "KeyType" : "HASH"}],                         
        "ProvisionedThroughput" : { "ReadCapacityUnits" : "1", "WriteCapacityUnits" : "1" }
        }]
      }
    },
    "ConsolePrivateAuditLogsDynamoDBTable" : {
      "Type" : "AWS::DynamoDB::Table",
      "DeletionPolicy" : "Retain",
      "DependsOn" : "ConsolePrivateIntegrationsDynamoDBTable" ,
      "Properties" : {
        "TableName" : {"Fn::Join" : ["", [{"Ref": "TablePrefix"}, "-audit-logs" ]]},
        "AttributeDefinitions" : [
          { "AttributeName" : "id", "AttributeType" : "S" },
          { "AttributeName" : "rack", "AttributeType" : "S" },
          { "AttributeName" : "timestamp", "AttributeType" : "S" }
        ],
        "KeySchema" : [{ "AttributeName" : "id", "KeyType" : "HASH" }],
        "ProvisionedThroughput" : { "ReadCapacityUnits" : "100", "WriteCapacityUnits" : "20" },
        "GlobalSecondaryIndexes" : [{
          "IndexName" : "rack-index",
          "Projection": { "ProjectionType": "ALL" },
          "KeySchema" : [
            { "AttributeName": "rack", "KeyType": "HASH" },
            { "AttributeName": "timestamp", "KeyType": "RANGE" }
          ],
          "ProvisionedThroughput" : { "ReadCapacityUnits" : "100", "WriteCapacityUnits" : "20" }
        }]
      }
    },
    "ConsolePrivateDeployKeysDynamoDBTable" : {
      "Type" : "AWS::DynamoDB::Table",
      "DeletionPolicy" : "Retain",
      "DependsOn" : "ConsolePrivateAuditLogsDynamoDBTable" ,
      "Properties" : {
        "TableName" : {"Fn::Join" : ["", [{"Ref": "TablePrefix"}, "-deploy-keys" ]]},
        "AttributeDefinitions" : [
          { "AttributeName" : "id", "AttributeType" : "S" },
          { "AttributeName" : "key-hash", "AttributeType" : "S" },
          { "AttributeName" : "organization-id", "AttributeType" : "S" },
        ],
        "KeySchema" : [{ "AttributeName" : "id", "KeyType" : "HASH" }],
        "ProvisionedThroughput" : { "ReadCapacityUnits" : "100", "WriteCapacityUnits" : "20" },
        "GlobalSecondaryIndexes" : [{
          "IndexName" : "key-hash-index",
          "Projection": { "ProjectionType": "ALL" },
          "KeySchema" : [
            { "AttributeName": "key-hash", "KeyType": "HASH" }
          ],
          "ProvisionedThroughput" : { "ReadCapacityUnits" : "100", "WriteCapacityUnits" : "20" }
        }, {
          "IndexName" : "organization-id-index",
          "Projection": { "ProjectionType": "ALL" },
          "KeySchema" : [
            { "AttributeName": "organization-id", "KeyType": "HASH" }
          ],
          "ProvisionedThroughput" : { "ReadCapacityUnits" : "100", "WriteCapacityUnits" : "20" }
        }]
      }
    }
  }
}
